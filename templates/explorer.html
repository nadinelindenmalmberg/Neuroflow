<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Explorer</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: "#191A23",
              primary: "#16161D",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-[#191A23] text-gray-200">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside
        class="w-64 bg-[#16161D] p-4 min-h-screen flex flex-col justify-between"
      >
        <div>
          <h2 class="text-xl font-bold mb-4">Metrics</h2>
          <ul id="metrics-list" class="space-y-1">
            {% for metric in metrics %}
            <li>
              <button
                class="w-full text-left px-2 py-1 hover:bg-gray-800 rounded metric-btn"
                data-metric="{{ metric }}"
              >
                {{ metric }}
              </button>
            </li>
            {% endfor %}
          </ul>
        </div>
        <!-- Cancel Exploration Button -->
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 p-6">
        <p class="flex items-center text-gray-400 text-sm">
          <a
            href="{{ url_for('dashboard') }}"
            class="hover:text-white transition"
            >Dashboard</a
          >
          <span class="mx-2 text-gray-500">/</span>
          <span class="text-white">Explorer</span>
        </p>

        <!-- Graph Container: Similar to a permanent graph card -->
        <div
          id="explorer-graph"
          class="glass p-6 rounded-xl space-y-4 graph-card bg-[rgba(255,255,255,0.05)] border border-[rgba(255,255,255,0.1)] w-full max-w-[900px]"
          data-graph-id="{{ graph_id }}"
        >
          <h3 class="text-lg font-semibold">{{graph_name}}</h3>
          <div id="explorer-chart" class="mt-4"></div>
          <div class="flex justify-between">
            <form action="{{ url_for('cancel_explorer') }}" method="POST">
              <button type="submit" class="button">Cancel Exploration</button>
            </form>
            <form action="{{ url_for('add_temp_graph')}}" method="POST">
              <button id="add-graph-btn" class="button">
                + Add to dashboard
              </button>
            </form>
          </div>
          <div></div>
        </div>
      </main>
    </div>

    <!-- JavaScript: Event Listeners for Metric Buttons -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let selectedMetrics = [];
        let chart;

        // We'll keep our own array of series objects
        let currentSeries = [];

        // Parse initial data from Flask (array of { name, data } objects)
        const plotData = JSON.parse(
          '{{ plot_data | default("[]") | tojson | safe }}'
        );
        console.log("Initial plotData:", plotData);

        // Initialize currentSeries with whatever came from Flask
        currentSeries = [...plotData];

        // Chart configuration
        const options = {
          chart: {
            type: "area",
            foreColor: "#ffffff",
            animations: { enabled: true },
          },
          series: currentSeries, // we use our own array here
          xaxis: { type: "datetime" },
          fill: {
            type: "gradient",
            gradient: {
              shadeIntensity: 1,
              inverseColors: false,
              opacityFrom: 0.6,
              opacityTo: 0,
              stops: [20, 100],
            },
          },
          colors: [
            "#FF4560",
            "#00E396",
            "#008FFB",
            "#FEB019",
            "#775DD0",
            "#FF66C3",
            "#26A69A",
            "#546E7A",
            "#D4526E",
            "#F86624",
          ],
          dataLabels: { enabled: false },
          stroke: { curve: "smooth", width: 2 },
          grid: { show: false },
          tooltip: {
            shared: true,
            theme: "dark",
            y: {
              formatter: function (val) {
                return val !== null && val !== undefined ? val.toFixed(0) : "";
              },
            },
          },
          legend: {
            position: "bottom",
            horizontalAlign: "center",
            labels: { colors: "white" },
          },
        };

        // Initialize the chart if the container exists
        const chartElement = document.querySelector("#explorer-chart");
        if (chartElement) {
          chart = new ApexCharts(chartElement, options);
          chart.render();
        }

        // Function to toggle (add/remove) a metric
        function updateChartWithMetric(metric) {
          console.log("User clicked metric:", metric);

          // If it’s already selected, remove it from both selectedMetrics and currentSeries
          if (selectedMetrics.includes(metric)) {
            selectedMetrics = selectedMetrics.filter((m) => m !== metric);
            currentSeries = currentSeries.filter((s) => s.name !== metric);
            chart.updateSeries(currentSeries);
            return;
          }
          //THIS IS WHERE I STOPPED - NEED TO UNDERSTNAD WHERE METRIC NAME IS COMING FROM TO PASS INTO SELECTED METRICS

          // Otherwise, fetch and add
          fetch(`/get-metric-data/${encodeURIComponent(metric)}`)
            .then((response) => response.json()) //converts response to JSON
            .then((data) => {
              //assigns JSON response to "data" used in the function
              if (!data.series) {
                console.error("No series data returned for metric:", metric);
                return;
              }

              // Mark this metric as selected
              selectedMetrics.push(metric);

              // Add the fetched series to currentSeries
              currentSeries.push({
                name: data.series.name, // e.g. "PBF"
                data: data.series.data, // array of { x, y } points
              });

              // Re-render the chart with our updated local array
              chart.updateSeries(currentSeries);
            })
            .catch((err) => console.error("Error fetching metric data:", err));
        }

        // Attach event listeners to each metric button
        document.querySelectorAll(".metric-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            updateChartWithMetric(btn.dataset.metric)
          );
        });

        const addGraphBtn = document.getElementById("add-graph-btn");

        if (addGraphBtn) {
          addGraphBtn.addEventListener("click", (e) => {
            e.preventDefault();

            fetch("/add-temp-graph", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ metrics: selectedMetrics }),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
              })
              .then((data) => {
                // ✅ Missing closing parenthesis fixed
                window.location.href = "/";
              }) // ✅ Closing parenthesis added here
              .catch((err) => console.error(err)); // ✅ Closing parenthesis in the right place
          });
        }
      });
    </script>
  </body>
</html>
